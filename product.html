<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle del Producto</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .media-container {
            max-height: 70vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #f8f9fa;
            position: relative;
        }
        .media-content {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
        }
        .gallery-nav {
            position: absolute;
            top: 50%;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            transform: translateY(-50%);
            z-index: 10;
        }
        .nav-btn {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 20px;
            color: #2d3748;
        }
        .nav-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }
        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .gallery-thumbnails {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            background: #f8f9fa;
            overflow-x: auto;
        }
        .thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .thumbnail:hover, .thumbnail.active {
            border-color: #3B82F6;
            transform: scale(1.1);
        }
        .video-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 5;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50vh;
            flex-direction: column;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <nav class="bg-gray-800 text-white py-4 px-6">
        <div class="container mx-auto flex justify-between items-center">
            <a href="index.html" class="text-lg font-semibold">‚Üê Volver a Tienda</a>
            <a href="admin.html" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">
                Panel Admin
            </a>
        </div>
    </nav>

    <main class="container mx-auto py-8 px-4">
        <div id="product-detail" class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="loading">
                <i class="fas fa-spinner fa-spin fa-2x text-blue-500 mb-4"></i>
                <p>Cargando producto...</p>
            </div>
        </div>
    </main>

    <script>
        // Variables globales
        let currentMediaIndex = 0;
        let mediaElements = [];

        // Cargar detalles del producto
        document.addEventListener("DOMContentLoaded", () => {
            console.log("üîÑ Iniciando carga de producto...");
            
            const urlParams = new URLSearchParams(window.location.search);
            const productIndex = urlParams.get('index');
            
            console.log("üìã √çndice de producto desde URL:", productIndex);
            
            if (productIndex === null) {
                console.error("‚ùå No se proporcion√≥ √≠ndice de producto en la URL");
                renderProductNotFound("No se especific√≥ ning√∫n producto");
                return;
            }

            try {
                // Obtener productos del localStorage
                const productsData = localStorage.getItem("products");
                console.log("üì¶ Datos de productos en localStorage:", productsData);
                
                if (!productsData) {
                    console.error("‚ùå No hay datos en localStorage");
                    renderProductNotFound("No se encontraron productos");
                    return;
                }
                
                const products = JSON.parse(productsData);
                console.log("‚úÖ Productos parseados:", products);
                
                if (!Array.isArray(products)) {
                    console.error("‚ùå Los productos no son un array v√°lido");
                    renderProductNotFound("Datos de productos inv√°lidos");
                    return;
                }
                
                if (productIndex < 0 || productIndex >= products.length) {
                    console.error("‚ùå √çndice de producto fuera de rango");
                    renderProductNotFound("El producto solicitado no existe");
                    return;
                }
                
                const product = products[productIndex];
                console.log("üìä Producto encontrado:", product);
                
                if (!product) {
                    console.error("‚ùå Producto no definido");
                    renderProductNotFound("El producto no est√° definido");
                    return;
                }
                
                mediaElements = product.gallery || [];
                console.log("üñºÔ∏è Medios encontrados:", mediaElements.length);
                
                renderProductDetail(product);
                setupGalleryNavigation();
                
            } catch (error) {
                console.error("‚ùå Error al cargar producto:", error);
                renderProductNotFound("Error al cargar el producto: " + error.message);
            }
        });

        // Renderizar detalles del producto
        function renderProductDetail(product) {
            const mediaContent = renderGallery();
            
            // Plantilla del producto
            const productHTML = `
                <div class="media-container">
                    ${mediaContent}
                    ${mediaElements.length > 1 ? `
                    <div class="gallery-nav">
                        <button class="nav-btn" id="prev-btn" onclick="changeMedia(-1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="nav-btn" id="next-btn" onclick="changeMedia(1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    ` : ''}
                    <div class="video-indicator" id="video-indicator" style="display: none;">
                        <i class="fas fa-video"></i> Video
                    </div>
                </div>
                
                ${mediaElements.length > 0 ? `
                <div class="gallery-thumbnails" id="gallery-thumbnails">
                    ${renderThumbnails()}
                </div>
                ` : ''}
                
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <h2 class="text-3xl font-bold text-gray-800">${product.name || 'Producto sin nombre'}</h2>
                        <span class="text-3xl font-bold text-green-600">S/ ${product.price ? product.price.toFixed(2) : '0.00'}</span>
                    </div>
                    
                    <div class="mb-6">
                        <span class="inline-block bg-${product.quantity > 0 ? 'green' : 'red'}-100 text-${product.quantity > 0 ? 'green' : 'red'}-800 text-sm px-3 py-1 rounded-full mb-4">
                            ${product.quantity > 0 ? `En stock: ${product.quantity} unidades` : 'Agotado'}
                        </span>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">Descripci√≥n</h3>
                        <p class="text-gray-600 leading-relaxed">${product.description || 'Sin descripci√≥n'}</p>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <h4 class="font-medium text-gray-700 mb-2">Informaci√≥n del producto:</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-500">Precio:</span>
                                <p class="font-semibold">S/ ${product.price ? product.price.toFixed(2) : '0.00'}</p>
                            </div>
                            <div>
                                <span class="text-gray-500">Disponibilidad:</span>
                                <p class="font-semibold">${product.quantity > 0 ? 'En stock' : 'Agotado'}</p>
                            </div>
                            <div>
                                <span class="text-gray-500">Unidades:</span>
                                <p class="font-semibold">${product.quantity || 0}</p>
                            </div>
                            <div>
                                <span class="text-gray-500">Agregado:</span>
                                <p class="font-semibold">${product.createdAt ? new Date(product.createdAt).toLocaleDateString() : 'Fecha desconocida'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById("product-detail").innerHTML = productHTML;
            updateNavigationButtons();
            
            // Mostrar indicador de video si es necesario
            if (mediaElements.length > 0 && mediaElements[currentMediaIndex].type === 'video') {
                document.getElementById('video-indicator').style.display = 'block';
            }
        }

        // Renderizar galer√≠a principal
        function renderGallery() {
            if (mediaElements.length === 0) {
                return '<div class="text-center text-gray-500 p-8"><i class="fas fa-image fa-3x mb-4"></i><p>No hay medios disponibles</p></div>';
            }

            const media = mediaElements[currentMediaIndex];
            if (media.type === 'video') {
                return `
                    <video controls class="media-content" id="main-media">
                        <source src="${media.url}" type="video/mp4">
                        Tu navegador no soporta videos.
                    </video>
                `;
            } else {
                return `<img src="${media.url}" alt="Producto" class="media-content" id="main-media">`;
            }
        }

        // Renderizar miniaturas
        function renderThumbnails() {
            if (mediaElements.length === 0) return '';

            return mediaElements.map((media, index) => {
                const isActive = index === currentMediaIndex ? 'active' : '';
                if (media.type === 'video') {
                    return `
                        <div class="thumbnail-container">
                            <img src="${media.url}" alt="Miniatura video" 
                                 class="thumbnail ${isActive}" onclick="changeToMedia(${index})">
                            <div class="video-play-icon">‚ñ∂</div>
                        </div>
                    `;
                } else {
                    return `
                        <img src="${media.url}" alt="Miniatura" 
                             class="thumbnail ${isActive}" onclick="changeToMedia(${index})">
                    `;
                }
            }).join('');
        }

        // Configurar navegaci√≥n de la galer√≠a
        function setupGalleryNavigation() {
            updateNavigationButtons();
            
            // Event listeners para teclado
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') {
                    changeMedia(-1);
                } else if (e.key === 'ArrowRight') {
                    changeMedia(1);
                }
            });
        }

        // Cambiar medio
        function changeMedia(direction) {
            if (mediaElements.length <= 1) return;
            
            currentMediaIndex += direction;
            
            // Navegaci√≥n circular
            if (currentMediaIndex < 0) {
                currentMediaIndex = mediaElements.length - 1;
            } else if (currentMediaIndex >= mediaElements.length) {
                currentMediaIndex = 0;
            }
            
            updateMediaDisplay();
        }

        // Cambiar a un medio espec√≠fico
        function changeToMedia(index) {
            if (index >= 0 && index < mediaElements.length) {
                currentMediaIndex = index;
                updateMediaDisplay();
            }
        }

        // Actualizar visualizaci√≥n del medio
        function updateMediaDisplay() {
            if (mediaElements.length === 0) return;
            
            const media = mediaElements[currentMediaIndex];
            const mainMedia = document.getElementById('main-media');
            const videoIndicator = document.getElementById('video-indicator');
            const thumbnails = document.querySelectorAll('.thumbnail');
            
            if (media.type === 'video') {
                mainMedia.outerHTML = `
                    <video controls class="media-content" id="main-media">
                        <source src="${media.url}" type="video/mp4">
                        Tu navegador no soporta videos.
                    </video>
                `;
                if (videoIndicator) videoIndicator.style.display = 'block';
            } else {
                mainMedia.outerHTML = `<img src="${media.url}" alt="Producto" class="media-content" id="main-media">`;
                if (videoIndicator) videoIndicator.style.display = 'none';
            }
            
            // Actualizar miniaturas activas
            thumbnails.forEach((thumb, index) => {
                if (index === currentMediaIndex) {
                    thumb.classList.add('active');
                } else {
                    thumb.classList.remove('active');
                }
            });
            
            updateNavigationButtons();
        }

        // Actualizar botones de navegaci√≥n
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            if (prevBtn && nextBtn) {
                if (mediaElements.length <= 1) {
                    prevBtn.style.display = 'none';
                    nextBtn.style.display = 'none';
                } else {
                    prevBtn.style.display = 'flex';
                    nextBtn.style.display = 'flex';
                }
            }
        }

        // Renderizar producto no encontrado
        function renderProductNotFound(message = "El producto que buscas no existe o ha sido eliminado.") {
            const productDetail = document.getElementById("product-detail");
            productDetail.innerHTML = `
                <div class="p-8 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <h3 class="mt-4 text-lg font-medium text-gray-900">Producto no encontrado</h3>
                    <p class="mt-1 text-gray-500">${message}</p>
                    <div class="mt-6">
                        <a href="index.html" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                            Volver a la Tienda
                        </a>
                    </div>
                </div>
            `;
        }

        // Hacer funciones globales para los onclick
        window.changeMedia = changeMedia;
        window.changeToMedia = changeToMedia;
    </script>
</body>
</html>